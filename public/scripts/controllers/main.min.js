"use strict";angular.module("restaurant").controller("MainCtrl",["$scope","$cookies","MenuService",function(a,b,c){a.dataAJAXed=!1,a.menu={},a.order={main:[],other:[],total:0,mainMeals:0,otherMeals:0,confirm:!1},a.existingOrder={},a.existingOrder.currentMainOrder="";var d=b.order;d&&d.match(/((\d*[a-z]*)+|([a-z]*\d*)+)/i)?a.existingOrder.currentMainOrder=d:b.order="",a.addToBasket=function(c,d){var f=b.order,g=a.menu.meals.filter(function(a,b,d){return d[b].id===c})[0];if(e(a.order.main,c).exist)a.order.main[e(a.order.main,c).index].amount+=1,a.order.mainMeals+=1,a.order.total=(parseFloat(a.order.total)+parseFloat(g.price)).toFixed(2);else if(e(a.order.other,c).exist)a.order.other[e(a.order.other,c).index].amount+=1,a.order.otherMeals+=1,a.order.total=(parseFloat(a.order.total)+parseFloat(g.price)).toFixed(2);else{var h=g.tags.length&&g.tags.filter(function(a,b,c){return c[b].match(/course/i)}).length?g.tags.filter(function(a,b,c){return c[b].match(/course/i)})[0].substring(8):"other";a.order.total=(parseFloat(a.order.total)+parseFloat(g.price)).toFixed(2),"main_courses"==h?(a.order.main.push(g),a.order.mainMeals+=1,g.amount+=1):(a.order.other.push(g),a.order.otherMeals+=1,g.amount+=1),d&&(b.order=f.match(/_((\d*[a-z]*)+|([a-z]*\d*)+)/i)?f+"_"+g.id:"_"+g.id)}};var e=function(a,b){var c=0,d=a.filter(function(d,e){return a[e].id===b&&(c=e),a[e].id===b}).length;return d?{exist:!0,index:c}:{exist:!1}};a.getOrder=function(){if(a.existingOrder.currentMainOrder.length){var b=a.existingOrder.currentMainOrder.split("_");angular.forEach(b,function(c,d,e){""!=b[d].trim()&&a.addToBasket(b[d],!1)})}},a.addRemoveMeals=function(c,d,e){var f=b.order,g="";e==-1?"main"==c?(a.order.main[d].amount-=1,a.order.total=(parseFloat(a.order.total)-parseFloat(a.order.main[d].price)).toFixed(2),0==a.order.main[d].amount&&(g=f.replace("_"+a.order.main[d].id,""),b.order=g,a.order.main.splice(d,1),setTimeout(function(){a.$digest()},0),0==a.order.main.length&&0==a.order.other.length&&(a.order.confirm=!1,b.order="",setTimeout(function(){a.$digest()},0)))):(a.order.other[d].amount-=1,a.order.total=(parseFloat(a.order.total)-parseFloat(a.order.other[d].price)).toFixed(2),0==a.order.other[d].amount&&(g=f.replace("_"+a.order.other[d].id,""),b.order=g,a.order.other.splice(d,1),setTimeout(function(){a.$digest()},0),0==a.order.main.length&&0==a.order.other.length&&(a.order.confirm=!1,b.order="",setTimeout(function(){a.$digest()},0)))):"main"==c?(a.order.main[d].amount+=1,a.order.total=(parseFloat(a.order.total)+parseFloat(a.order.main[d].price)).toFixed(2)):(a.order.other[d].amount+=1,a.order.total=(parseFloat(a.order.total)+parseFloat(a.order.other[d].price)).toFixed(2)),setTimeout(function(){a.$digest()},0)},c.get().success(function(c){a.menu=c,a.menu.meals.forEach(function(a,b,c){c[b].amount=0}),console.log(c),b.order&&!a.dataAJAXed&&(a.dataAJAXed=!0,a.getOrder()),a.$broadcast("loaded")})}]).directive("toggleDescription",["$window","$timeout","$log",function(a,b,c){return{controller:"MainCtrl",restrict:"A",link:function(d,e,f){a.addEventListener("resize",function(){var a=document.body.clientWidth||document.documentElement.clientWidth,b=286*parseInt(Math.floor(a/286))+2;document.querySelector(".meals").style.width=b+"px"}),a.dispatchEvent(new Event("resize"));var g=function(){var a=document.querySelectorAll("span.showMore img"),b=document.querySelectorAll("div.slideDesc"),c=document.querySelectorAll("div.slideDesc .description");Object.getOwnPropertyNames(a).forEach(function(c,d,e){a[d].removeEventListener("click",function(){}),a[d].addEventListener("click",function(a){console.log("desc clicked");var c=parseInt(a.target.attributes.getNamedItem("data-ind").textContent);b[c].classList?b[c].classList.contains("scrollUp")?(b[c].classList.remove("scrollUp"),b[c].style.top="-55px"):(b[c].classList.add("scrollUp"),b[c].style.top=50-b[c].scrollHeight+"px"):b[c].className.match(/scrollUp/i)?(b[c].className=b[c].className.replace(" scrollUp",""),b[c].style.top="-55px"):(b[c].className=b[c].className+" scrollUp",b[c].style.top=50-b[c].scrollHeight+"px")})}),Object.getOwnPropertyNames(c).forEach(function(b,d){c[d].scrollHeight<50&&(a[d].parentElement.style.display="none")})};d.$on("loaded",function(){document.querySelectorAll(".slideDesc").length==d.menu.meals.length?(c.log("#### DEV #### \nContent for manipulation has been loaded.\n#### DEV ####"),g()):b(function(){d.$emit("loaded")},300)})}}}]);